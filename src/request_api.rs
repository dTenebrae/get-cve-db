use crate::json_schema;

use log::{info, warn};
use reqwest::{Client, Error as ReqError};
use reqwest::header::{HeaderMap, USER_AGENT, HeaderValue, CONTENT_TYPE, HeaderName, ACCEPT};

/// Returns a HeaderMap contains headers for reqwest::Client request.
/// 
/// As input accept api key of type Option<&str>
/// 
/// # Example
/// ```
/// let api_token = Some("quite-a-random-number")
/// 
/// let response = Client::new()
///     .get(url)
///     .headers(construct_headers(api_token))
///     .send()
///     .await
///     .unwrap();
/// 
/// ```
/// 
fn construct_headers(api_key: Option<&str>) -> HeaderMap {

    let mut headers: HeaderMap = HeaderMap::new();
    headers.insert(USER_AGENT, HeaderValue::from_static("reqwest"));
    headers.insert(CONTENT_TYPE, HeaderValue::from_static("application/json"));
    headers.insert(ACCEPT, HeaderValue::from_static("application/json"));
    match api_key {
        Some(api_key_value) => {
            headers.insert(HeaderName::from_static("apikey"), 
                        HeaderValue::from_str(&api_key_value).unwrap());
        },
        None => ()
    }
    headers
}

/// Return response from nist(at moment) API in a form of structs,
/// described in json_schema.rs
/// 
/// As input accept url of type String - API url
/// api key of type Option<&str> - api key (if required)
/// 
/// # Example
/// ```
/// let url = String::from("some-url");
/// let api_token = Some("quite-a-random-number")
/// 
/// let json_resp: json_schema::CveRoot = get_response(url, api_token).await?;
/// 
/// ```
/// 
pub async fn get_response(url: String, api_key: Option<&str>) -> Result<json_schema::CveRoot, ReqError>{
    let response = Client::new()
        .get(url)
        .headers(construct_headers(api_key))
        .send()
        .await
        .unwrap();
    
    match response.status() {
        reqwest::StatusCode::OK => {
            let json_future = response.json::<json_schema::CveRoot>();
            match json_future.await {
                Ok(json_response) => return Ok(json_response),
                Err(e) => {
                    info!("Json parse error: {e}");
                    return Err(e);
                }
            }
        },
        reqwest::StatusCode::BAD_REQUEST => warn!("Bad request"),
        reqwest::StatusCode::GATEWAY_TIMEOUT => warn!("Timeout"),
        reqwest::StatusCode::BAD_GATEWAY => warn!("Bad gateway"),
        reqwest::StatusCode::SERVICE_UNAVAILABLE => warn!("Service unavailable"),
        _ => warn!("Something wrong: {}", response.status()),
    }
    Err(response.error_for_status().err().unwrap())
}